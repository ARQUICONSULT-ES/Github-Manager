// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  email         String    @unique
  password      String    
  githubToken   String?   @map("github_token")
  githubAvatar  String?   @map("github_avatar")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Permisos de acceso a módulos
  canAccessRepos        Boolean  @default(false) @map("can_access_repos")
  canAccessCustomers    Boolean  @default(false) @map("can_access_customers")
  allCustomers          Boolean  @default(false) @map("all_customers")
  canAccessAdmin        Boolean  @default(false) @map("can_access_admin")

  // Relación: Un usuario puede tener acceso a muchos customers (solo aplica si canAccessCustomers=true y allCustomers=false)
  allowedCustomers  UserCustomer[]
}

// Tabla principal: Customers
model Customer {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerName String   @db.VarChar(50)
  imageBase64  String?  @db.Text
  tenants      Tenant[]
  
  // Relación: Un customer puede ser accedido por muchos usuarios
  allowedUsers UserCustomer[]

  @@map("customers")
}

// Tabla intermedia para la relación muchos a muchos entre User y Customer
model UserCustomer {
  userId     String   @db.Uuid
  customerId String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([userId, customerId])
  @@map("user_customers")
}

// Tabla de Tenants
model Tenant {
  id              String        @id @db.Uuid
  customerId      String        @db.Uuid
  customer        Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  description     String?       @db.VarChar(500)
  createdAt       DateTime
  modifiedAt      DateTime
  // Campos de conexión
  connectionId    String?       @db.Uuid
  grantType       String?       @db.VarChar(100)
  clientId        String?       @db.Uuid
  clientSecret    String?       @db.Text
  scope           String?       @db.VarChar(200)
  token           String?       @db.Text
  tokenExpiresAt  DateTime?
  environments    Environment[]

  @@map("tenants")
}

// Tabla relacionada: Environments
model Environment {
  tenantId          String      @db.Uuid
  name              String      @db.VarChar(50)
  type              String?     @db.VarChar(50)
  status            String?     @db.VarChar(50)
  webClientUrl      String?     @db.VarChar(1000)
  locationName      String?     @db.VarChar(50)
  applicationVersion String?    @db.VarChar(50)
  platformVersion   String?     @db.VarChar(50)
  tenant            Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  installedApps     InstalledApp[]

  @@id([tenantId, name])
  @@map("environments")
}

// Tabla relacionada: InstalledApps
model InstalledApp {
  tenantId        String      @db.Uuid
  environmentName String      @db.VarChar(100)
  id              String      @db.Uuid
  name            String      @db.VarChar(255)
  version         String      @db.VarChar(100)
  publisher       String      @db.VarChar(255)
  publishedAs     String      @db.VarChar(20)
  state           String?     @db.VarChar(50)
  environment     Environment @relation(fields: [tenantId, environmentName], references: [tenantId, name], onDelete: Cascade)

  @@id([tenantId, environmentName, id])
  @@map("installed_apps")
}

// Tabla de Aplicaciones
model Application {
  id                  String   @id @db.Uuid
  name                String   @db.VarChar(255)
  publisher           String   @db.VarChar(255)
  githubRepoName      String   @map("github_repo_name") @db.VarChar(255)
  githubUrl           String?  @map("github_url") @db.VarChar(500)
  latestReleaseVersion String? @map("latest_release_version") @db.VarChar(100)
  latestReleaseDate   DateTime? @map("latest_release_date")
  logoBase64          String?  @map("logo_base64") @db.Text
  idRanges            Json?    @map("id_ranges")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("applications")
}
