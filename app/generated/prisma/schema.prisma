generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  email               String               @unique
  password            String?
  githubToken         String?              @map("github_token")
  githubAvatar        String?              @map("github_avatar")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  canAccessRepos      Boolean              @default(false) @map("can_access_repos")
  canAccessCustomers  Boolean              @default(false) @map("can_access_customers")
  allCustomers        Boolean              @default(false) @map("all_customers")
  canAccessAdmin      Boolean              @default(false) @map("can_access_admin")
  isActive            Boolean              @default(false) @map("is_active")
  passwordSetupTokens PasswordSetupToken[]
  allowedCustomers    UserCustomer[]
}

model PasswordSetupToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token     String    @unique @db.VarChar(64)
  userId    String    @db.Uuid
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_setup_tokens")
}

model Customer {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerName        String             @db.VarChar(50)
  imageBase64         String?
  infraestructureType InfrastructureType @default(Saas)
  description         String?
  tenants             Tenant[]
  allowedUsers        UserCustomer[]

  @@map("customers")
}

model UserCustomer {
  userId     String   @db.Uuid
  customerId String   @db.Uuid
  assignedAt DateTime @default(now())
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, customerId])
  @@map("user_customers")
}

model Tenant {
  id             String        @id @db.Uuid
  customerId     String        @db.Uuid
  description    String?       @db.VarChar(500)
  createdAt      DateTime
  modifiedAt     DateTime
  connectionId   String?       @db.Uuid
  grantType      String?       @db.VarChar(100)
  clientId       String?       @db.Uuid
  clientSecret   String?
  scope          String?       @db.VarChar(200)
  token          String?
  tokenExpiresAt DateTime?
  authContext    String?
  environments   Environment[]
  customer       Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("tenants")
}

model Environment {
  tenantId           String         @db.Uuid
  name               String         @db.VarChar(50)
  type               String?        @db.VarChar(50)
  status             String?        @db.VarChar(50)
  webClientUrl       String?        @db.VarChar(1000)
  locationName       String?        @db.VarChar(50)
  applicationVersion String?        @db.VarChar(50)
  platformVersion    String?        @db.VarChar(50)
  tenant             Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  installedApps      InstalledApp[]

  @@id([tenantId, name])
  @@map("environments")
}

model InstalledApp {
  tenantId        String      @db.Uuid
  environmentName String      @db.VarChar(100)
  id              String      @db.Uuid
  name            String      @db.VarChar(255)
  version         String      @db.VarChar(100)
  publisher       String      @db.VarChar(255)
  publishedAs     String      @db.VarChar(20)
  state           String?     @db.VarChar(50)
  environment     Environment @relation(fields: [tenantId, environmentName], references: [tenantId, name], onDelete: Cascade)

  @@id([tenantId, environmentName, id])
  @@map("installed_apps")
}

model Application {
  id                      String    @id @db.Uuid
  name                    String    @db.VarChar(255)
  publisher               String    @db.VarChar(255)
  githubRepoName          String    @map("github_repo_name") @db.VarChar(255)
  githubUrl               String?   @map("github_url") @db.VarChar(500)
  latestReleaseVersion    String?   @map("latest_release_version") @db.VarChar(100)
  latestReleaseDate       DateTime? @map("latest_release_date")
  latestPrereleaseVersion String?   @map("latest_prerelease_version") @db.VarChar(100)
  latestPrereleaseDate    DateTime? @map("latest_prerelease_date")
  logoBase64              String?   @map("logo_base64")
  idRanges                Json?     @map("id_ranges")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@map("applications")
}

enum InfrastructureType {
  Saas
  OnPremise
}
